@page "/calculator"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using NzPayeCalc.Web.Models
@using NzPayeCalc.Web.Services
@inject PayeApiClient ApiClient
@inject ILogger<Calculator> Logger

<PageTitle>NZ PAYE Calculator</PageTitle>

<div class="calculator-container">
    <section class="calculator-header">
        <h1>NZ PAYE Calculator</h1>
        <p>Calculate your monthly take-home pay based on your annual salary</p>
    </section>

    <section class="calculator-input">
        <EditForm Model="@salaryInput" OnValidSubmit="@HandleCalculate" FormName="PayeCalculatorForm">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="annual-salary" class="form-label">
                    Annual Salary (NZD)
                </label>
                <div class="input-wrapper">
                    <span class="currency-symbol">$</span>
                    <InputNumber 
                        id="annual-salary" 
                        @bind-Value="salaryInput.AnnualSalary" 
                        class="form-control salary-input"
                        placeholder="60,000"
                        aria-describedby="salary-help" />
                </div>
                <ValidationMessage For="@(() => salaryInput.AnnualSalary)" class="validation-message" />
                <small id="salary-help" class="form-text">
                    Enter your gross annual salary before tax
                </small>
            </div>

            <div class="form-group mt-3">
                <label for="kiwisaver-rate" class="form-label">
                    KiwiSaver Contribution Rate
                </label>
                <InputSelect 
                    id="kiwisaver-rate"
                    @bind-Value="salaryInput.KiwiSaverRate"
                    class="form-control"
                    aria-describedby="kiwisaver-help">
                    <option value="0.03">3%</option>
                    <option value="0.04">4%</option>
                    <option value="0.06">6%</option>
                    <option value="0.08">8%</option>
                    <option value="0.10">10%</option>
                </InputSelect>
                <small id="kiwisaver-help" class="form-text">
                    Select your KiwiSaver employee contribution rate
                </small>
            </div>

            <div class="form-group mt-3">
                <div class="form-check">
                    <InputCheckbox 
                        id="has-student-loan"
                        @bind-Value="salaryInput.HasStudentLoan"
                        class="form-check-input" />
                    <label for="has-student-loan" class="form-check-label">
                        Do you have a student loan?
                    </label>
                </div>
                <small class="form-text">
                    Student loan repayments apply if your income exceeds the repayment threshold
                </small>
            </div>

            <button type="submit" class="btn btn-primary mt-3" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Calculating...</span>
                }
                else
                {
                    <span>Calculate</span>
                }
            </button>
        </EditForm>
    </section>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mt-4" role="alert">
            <strong>Error:</strong> @errorMessage
            <button type="button" class="btn-close" @onclick="ClearError" aria-label="Close"></button>
        </div>
    }

    @if (results != null && !isLoading)
    {
        <section class="calculator-results mt-4">
            <div class="results-card">
                <h2>Monthly Breakdown</h2>
                
                <dl class="results-list">
                    <div class="result-row">
                        <dt>Monthly Gross Salary</dt>
                        <dd>@results.Monthly.GrossSalary.ToString("C2")</dd>
                    </div>
                    <div class="result-row deduction">
                        <dt>PAYE Tax</dt>
                        <dd>-@results.Monthly.PayeTax.ToString("C2")</dd>
                    </div>
                    <div class="result-row deduction">
                        <dt>KiwiSaver (@((results.KiwiSaverRate * 100).ToString("0"))%)</dt>
                        <dd>-@results.Monthly.KiwiSaver.ToString("C2")</dd>
                    </div>
                    <div class="result-row deduction">
                        <dt>ACC Levy (1.53%)</dt>
                        <dd>-@results.Monthly.AccLevy.ToString("C2")</dd>
                    </div>
                    @if (results.HasStudentLoan)
                    {
                        <div class="result-row deduction">
                            <dt>Student Loan (12%)</dt>
                            <dd>-@results.Monthly.StudentLoan.ToString("C2")</dd>
                        </div>
                    }
                    <div class="result-row take-home">
                        <dt>Take-Home Pay</dt>
                        <dd>@results.Monthly.TakeHomePay.ToString("C2")</dd>
                    </div>
                </dl>

                <details class="annual-breakdown mt-3">
                    <summary>View Annual Breakdown</summary>
                    <dl class="results-list mt-2">
                        <div class="result-row">
                            <dt>Annual Gross Salary</dt>
                            <dd>@results.Annual.GrossSalary.ToString("C2")</dd>
                        </div>
                        <div class="result-row deduction">
                            <dt>PAYE Tax</dt>
                            <dd>-@results.Annual.PayeTax.ToString("C2")</dd>
                        </div>
                        <div class="result-row deduction">
                            <dt>KiwiSaver (@((results.KiwiSaverRate * 100).ToString("0"))%)</dt>
                            <dd>-@results.Annual.KiwiSaver.ToString("C2")</dd>
                        </div>
                        <div class="result-row deduction">
                            <dt>ACC Levy (1.53%)</dt>
                            <dd>-@results.Annual.AccLevy.ToString("C2")</dd>
                        </div>
                        @if (results.HasStudentLoan)
                        {
                            <div class="result-row deduction">
                                <dt>Student Loan (12%)</dt>
                                <dd>-@results.Annual.StudentLoan.ToString("C2")</dd>
                            </div>
                        }
                        <div class="result-row take-home">
                            <dt>Take-Home Pay</dt>
                            <dd>@results.Annual.TakeHomePay.ToString("C2")</dd>
                        </div>
                    </dl>
                </details>
            </div>

            <div class="calculation-notes mt-3">
                <p class="text-muted small">
                    <strong>Note:</strong> This calculation uses 2025/2026 NZ tax rates (2024/2025 also available). 
                    This is an estimate and does not include other deductions such as union fees, insurance, or special tax codes.
                </p>
            </div>
        </section>
    }
</div>

@code {
    private SalaryInputModel salaryInput = new();
    private PayeCalculationResponse? results;
    private bool isLoading;
    private string? errorMessage;

    private class SalaryInputModel
    {
        [Required(ErrorMessage = "Annual salary is required")]
        [Range(1, 1000000, ErrorMessage = "Salary must be between $1 and $1,000,000")]
        public decimal AnnualSalary { get; set; } = 60000; // Default example value

        [Required(ErrorMessage = "KiwiSaver rate is required")]
        public decimal KiwiSaverRate { get; set; } = 0.03m; // Default 3%

        public bool HasStudentLoan { get; set; } = false;
    }

    private async Task HandleCalculate()
    {
        isLoading = true;
        errorMessage = null;
        results = null;

        try
        {
            results = await ApiClient.CalculateAsync(
                salaryInput.AnnualSalary,
                salaryInput.KiwiSaverRate,
                salaryInput.HasStudentLoan);
        }
        catch (ApplicationException ex)
        {
            errorMessage = ex.Message;
            Logger.LogWarning(ex, "Calculation failed for salary {Salary}", salaryInput.AnnualSalary);
        }
        catch (Exception ex)
        {
            errorMessage = "An unexpected error occurred. Please try again.";
            Logger.LogError(ex, "Unexpected error during calculation");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearError()
    {
        errorMessage = null;
    }
}
